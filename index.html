<form action = "" method = "post">
	<div>
		<label for="Score">轮空小分:</label>
		<input type = "number" id = "Score" name = "score_setting" min = 0 max = 2 value = 0>
	</div>
	<div>
		<label for="Rounds">总轮数:</label>
		<input type = "number" id = "Rounds" name = "rounds_setting" value = 0>
	</div>
	<div>
		<label for="Names>">名单文件:</label>
		<input type="file" id="Names" name = "Names_setting">
	</div>
	<div class="button">
		<button type="button" onclick = "start()">完成</button>
		<button type="reset">清空</button>
	</div>
</form>
<style>
	form {
	  /* Center the form on the page */
	  margin: 0 auto;
	  width: 400px;
	  /* Form outline */
	  padding: 1em;
	  border: 1px solid #CCC;
	  border-radius: 1em;
	}
</style>
<script>
	var totalRounds = 0;
	var currentRound = 0;
	var empty_score = 0;
	var totalCandidates = 0;
	var extras = 0;

	function start() {
		totalRounds = document.getElementById("Rounds").value;
		empty_score = document.getElementById("Score").value;

		if (document.getElementById("Names").files.length != 0) {
			  var file = document.getElementById("Names").files[0];
			  var reader = new FileReader();
			  reader.onload = function(progressEvent){
			    var lines = this.result.split('\n');
			    var innerHTML = "<table align=\"center\">" + generateHTMLForTableRow(["姓名", "总分", "小分","状态", "排名"], true);

			    window.candidates = [];
			    for(var line = 0; line < lines.length; line++){
			      innerHTML = innerHTML + generateHTMLForTableRow([lines[line], 0, 0, "参赛", 1], false);
			      candidates.push({name: lines[line], totalScore:0, bonus:0, nextTable:-1, opponent:-1, rank:1, status:"参赛"});
			    }
			    console.log(window.candidates);

			    innerHTML += "</table>";
			    innerHTML += generateHTMLForButtonForRound(currentRound);
			    totalCandidates = window.candidates.length;
			    extras = totalCandidates % 2;

			    document.body.innerHTML = innerHTML;
			  };
			  reader.readAsText(file);
		}
	};

	function generateHTMLForButtonForRound(round) {
		var text = "<center> <button type=\"button\" onclick=\"startRound()\"> 开始第" + round + "轮"+"</button></center>";
		return text;
	}

	function startRound() {
		currentRound++;
		var maxTotalScore = 0;
		if (currentRound == 1) {
			if (extras == 1) {
				var sitout = Math.floor((Math.random() * totalCandidates));
				generateFirstMatchUp(sitout);
			} else {
				generateFirstMatchUp(-1);
			}
		} else {
			for (var i = 0; i < window.candidates.length; i++) {
				console.log(document.getElementById("score_for_" + i ));
				window.candidates[i].totalScore += parseInt(document.getElementById("score_for_" + i).value);
				window.candidates[i].bonus += parseInt(document.getElementById("bonus_for_"+ i).value);
				window.candidates[i].opponent = -1;
				window.candidates[i].nextTable = -1;
			}
		}
		displayTable();
		return;
	}

	function displayTable() {
		var innerHTML = "<table align=\"center\">";
		innerHTML += generateHTMLForTableRow(["姓名", "排名", "总分", "小分","状态", "本轮桌号", "本轮对手", "本轮大分", "本轮小分", "退赛"], true);
		for (var i = 0; i < window.candidates.length; i++) {
			innerHTML += generateHTMLForTableRow([
				window.candidates[i].name,
				window.candidates[i].rank,
				window.candidates[i].totalScore,
				window.candidates[i].bonus,
				window.candidates[i].status,
				window.candidates[i].nextTable == -1 ? "轮空" : window.candidates[i].nextTable,
				window.candidates[i].opponent == -1 ? "轮空" : window.candidates[i].opponent,
				generateInputBoxForScore(i),
				generateInputBoxForBonus(i),
				generateDropoutButton(i),
				],
				false);
		}
		innerHTML += generateHTMLForButtonForRound(currentRound + 1);
		document.body.innerHTML = innerHTML;
		return;
	}

	function generateInputBoxForScore(index) {
		var innerHTML = "<input type=\"number\" id = \"score_for_" + index + "\" value = 0>";
		return innerHTML;
	}

	function generateInputBoxForBonus(index) {
		var innerHTML = "<input type=\"number\" id = \"bonus_for_" + index + "\" value = 0>";
		return innerHTML;
	}

	function generateDropoutButton(index) {
		var innerHTML = "<center> <button type=\"button\" onclick=\"\"> 退赛 </button></center>";
		return innerHTML;
	}

	function generateFirstMatchUp(sitout) {
		var candiNum = []
		for (var i = 0; i < totalCandidates; i++) {
			if (i != sitout) {
				candiNum.push(i);
			}
		}
		console.log(candiNum);
		console.log(window.candidates);
		var tableNumber = 1;
		for (var i = 0; i < totalCandidates; i++) {
			if (i != sitout && window.candidates[i].opponent == -1) {
				var opponentNum = Math.floor((Math.random() * candiNum.length));
				while (candiNum[opponentNum] == i) {
					opponentNum = Math.floor((Math.random() * candiNum.length));
				}
				var opponent = candiNum[opponentNum];
				candiNum.splice(opponentNum, 1);
				window.candidates[i].opponent = window.candidates[opponent].name;
				window.candidates[opponent].opponent = window.candidates[i].name;
				window.candidates[i].nextTable = tableNumber;
				window.candidates[opponent].nextTable = tableNumber;
				tableNumber++;

				for (var j = 0; j < candiNum.length; j++) {
					if (candiNum[j] == i) {
						candiNum.splice(j, 1);
						break;
					}
				}
			}
		}
		return;
	}

	function generateHTMLForTableRow(arr, isHeading) {
		var text = "<tr>"
		for (var i = 0; i < arr.length; i++) {
			if (isHeading) {
				text = text + "<th>" + arr[i] + "</th>";
			} else {
				text = text + "<td>" + arr[i] + "</td>";
			}
		}
		text += "</tr>";
		return text;
	}
</script>